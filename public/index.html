<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-L85T9YNHHR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-L85T9YNHHR');
  </script>
  <meta charset="UTF-8" />
  <title>Hustlers near me — hustlemaps.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      /* Softer light theme that matches lavender primary */
      --bg-primary: #ffffff; /* subtle lilac-tinted gray */
      --bg-secondary: #ffffff;
      --text-primary: #111111;
      --text-secondary: #555555;
      --text-muted: #666666;
      --border-color: #eeeeee;
      --input-bg: #ffffff;
      --input-border: #dddddd;
      --btn-primary-bg: #bfbaff; /* lavender */
      --btn-primary-color: #ffffff;
      --btn-secondary-bg: #f3f4f6;
      --btn-secondary-color: #111111;
      --btn-secondary-border: #e5e7eb;
      --badge-bg: #f3f4f6;
      --badge-border: #e5e7eb;
      --badge-text: #111111;
      --ask-bg: #fff8e1;
      --ask-border: #f7e5a2;
      --foot-bg: rgba(255,255,255,0.85);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-muted: #999999;
      --border-color: #404040;
      --input-bg: #2d2d2d;
      --input-border: #404040;
      --btn-primary-bg: #ffffff;
      --btn-primary-color: #111111;
      --btn-secondary-bg: #404040;
      --btn-secondary-color: #ffffff;
      --btn-secondary-border: #555555;
      --badge-bg: #404040;
      --badge-border: #555555;
      --badge-text: #ffffff;
      --ask-bg: #3d3d1a;
      --ask-border: #5a5a2a;
      --foot-bg: rgba(26,26,26,0.8);
    }

    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .app { 
      display: grid; 
      grid-template-columns: 320px 1fr; 
      height: 100%; 
    }
    
    @media (max-width: 768px) {
      .app { 
        grid-template-columns: 1fr; 
        grid-template-rows: 1fr;
        height: 100vh;
        position: relative;
      }
    }
    
    .panel { 
      padding: 16px 16px 24px; 
      border-right: 1px solid var(--border-color); 
      display:flex; 
      flex-direction:column; 
      overflow: hidden;
      background-color: var(--bg-primary);
    }
    
    @media (max-width: 768px) {
      .panel { 
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-primary);
        border-top: 1px solid var(--border-color);
        border-right: none;
        border-bottom: none;
        height: 0;
        overflow: hidden;
        transition: height 0.3s ease;
        z-index: 1000;
        -webkit-overflow-scrolling: touch;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        box-shadow: 0 -10px 30px rgba(0,0,0,0.15);
        padding-bottom: calc(24px + env(safe-area-inset-bottom));
      }
      
      .panel.open {
        height: 80vh;
        overflow-y: auto;
      }
      
      .panel.partial {
        height: 40vh;
        overflow-y: auto;
      }
    }
    .map { height: 100%; }
    
    @media (max-width: 768px) {
      .map { 
        height: 100vh;
        width: 100%;
        background: #e9eaf6; /* subtle map backdrop while tiles load */
      }
    }
    h1 { font-size: 20px; margin: 0 0 8px; color: var(--text-primary); }
    label { display:block; font-size:12px; color:var(--text-secondary); margin-top:12px; padding: 0 8px;}
    
    @media (max-width: 768px) {
      label { 
        margin-top: 8px; 
        padding: 0 4px;
        font-size: 11px;
      }
    }
    input, textarea { 
      width: calc(100% - 16px); 
      padding:8px; 
      border:1px solid var(--input-border); 
      border-radius:8px; 
      margin: 0 8px;
      background-color: var(--input-bg);
      color: var(--text-primary);
    }
    
    @media (max-width: 768px) {
      input, textarea { 
        padding: 6px 4px; 
        font-size: 13px;
        min-height: 28px;
        line-height: 1.2;
        -webkit-appearance: none;
        appearance: none;
        border-radius: 4px;
        margin: 0 4px;
      }
    }
    textarea { resize: none; }
    .btn { 
      margin:16px 8px 0; 
      width:calc(100% - 16px); 
      padding:12px; 
      border:none; 
      border-radius:10px; 
      font-weight:700; 
      cursor:pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    
    @media (max-width: 768px) {
      .btn { 
        padding: 10px 8px; 
        font-size: 14px;
        min-height: 36px;
        touch-action: manipulation;
        margin: 12px 4px 0;
        width: calc(100% - 8px);
      }
    }
    .btn-primary { background:var(--btn-primary-bg); color:var(--btn-primary-color); }
    .btn-danger { background:var(--btn-secondary-bg); color:var(--btn-secondary-color); border:1px solid var(--btn-secondary-border); }
    .btn-secondary { background:var(--btn-secondary-bg); color:var(--btn-secondary-color); border:1px solid var(--btn-secondary-border); }
    .btn-share { background:#5ec00d; color:#fff; border:1px solid #ccc; }
    .row { margin:8px 8px 0; font-size:12px; color:var(--text-secondary); }
    .badge { display:inline-block; background:var(--badge-bg); border:1px solid var(--badge-border); padding:4px 8px; border-radius:25px; font-size:12px; color: var(--badge-text); font-weight:600; }
    .me { border: 2px solid var(--text-primary); }
    .avatar { width: 28px; height: 28px; border-radius:50%; object-fit:cover; vertical-align:middle; margin-right:6px; }
    .person { display:flex; align-items:center; gap:8px; margin:8px 8px 0; }
    .one-line { display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .one-line strong { font-weight:800; }
    .one-line .handle { opacity:0.85; }
    .one-line .venue { opacity:0.9; }
    .subtitle { font-size:12px; color: var(--text-secondary); }
    .handle { opacity: 0.8; }
    .list { margin:12px 0 0; flex:1; overflow:auto; }
    .user-me { background: var(--btn-primary-bg); color: var(--btn-primary-color); padding: 12px; border-radius: 14px; margin-bottom: 12px; }
    .user-me .person { margin: 0; }
    .user-me .one-line { color: var(--btn-primary-color); }
    .user-me .one-line .handle, .user-me .one-line .venue { color: var(--btn-primary-color); }
    .user-me::after { content: "You"; display: block; text-align: center; font-size: 10px; margin-top: 4px; opacity: 0.8; }
    .user-list { max-height: 160px; overflow-y: auto; }
    .user-list .person { margin: 4px 0; padding: 4px; border-radius: 6px; transition: background-color 0.2s ease; }
    .user-list .person:hover { background-color: var(--btn-secondary-bg); }
    .bottom { margin-top:auto; padding:12px 8px 0; }
    .note { font-size:11px; color:var(--text-muted); margin-top:12px; }
    .ask { margin:12px 8px 0; padding:8px; background:var(--ask-bg); border:1px solid var(--ask-border); border-radius:8px; font-size:13px; }
    .foot { position: absolute; bottom: 8px; left: 8px; right: 330px; font-size:11px; background: var(--foot-bg); padding:4px 8px; border-radius:6px; z-index: 1000; }
    
    @media (max-width: 768px) {
      .foot { 
        right: 8px; 
        font-size: 10px;
        padding: 3px 6px;
      }
    }
    .leaflet-div-icon { background: transparent; border: none; }
    .pin { position: relative; }
    .pin-badge { background:transparent; color:var(--text-primary); padding:6px 8px; border-radius:12px; white-space:nowrap; font-size:20px; }
    .pin-emoji { margin-right:6px; }
    .pin-pulse { position:absolute; left:50%; top:0; width:10px; height:10px; margin-top:6px; background:var(--btn-primary-bg); border-radius:999px; transform:translateX(-50%); box-shadow:0 0 0 0 rgba(17,17,17,0.5); animation:pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(17,17,17,0.5);} 70% { box-shadow:0 0 0 14px rgba(17,17,17,0);} 100% { box-shadow:0 0 0 0 rgba(17,17,17,0);} }
    
    .theme-toggle {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--btn-secondary-bg);
      border: 1px solid var(--btn-secondary-border);
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-primary);
      transition: all 0.2s ease;
      z-index: 1001;
      -webkit-tap-highlight-color: transparent;
    }
    .theme-toggle:hover {
      opacity: 0.8;
    }
    .hidden { display: none; }
    
    @media (max-width: 768px) {
      .theme-toggle {
        top: 12px;
        right: 12px;
        padding: 10px;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
      }
    }
    
    /* Mobile drawer tab button */
    .drawer-tab {
      display: none;
    }
    
    @media (max-width: 768px) {
      .drawer-tab {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--btn-primary-bg);
        color: var(--btn-primary-color);
        border: none;
        border-radius: 25px;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        z-index: 1001;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        transition: all 0.2s ease;
      }
      
      .drawer-tab:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      }
      
      .drawer-tab:active {
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* Drawer handle */
    .drawer-handle {
      display: none;
    }
    
    @media (max-width: 768px) {
      .drawer-handle {
        display: block;
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 4px;
        background: var(--border-color);
        border-radius: 2px;
        cursor: pointer;
        touch-action: manipulation;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">🌙</button>
  <button class="drawer-tab" id="drawerTab">Controls</button>
  
  <div class="app">
    <div class="panel" id="panel">
      <div class="drawer-handle" id="drawerHandle"></div>
      <h1>HustleMaps.com</h1>
      <div class="row" id="headerNote">See nearby hustlers or tap <span class="badge">Lock In</span> to share your live pin.</div>
      <div class="row" id="locationPrompt" style="display:none;">
        <div class="ask">
          <strong>Enable location to see nearby hustlers</strong><br>
          <small>We need your location to show you who's working nearby, even when you're not locked in.</small>
          <div style="margin-top:8px;">
            <button id="enableLocation" class="btn btn-primary" style="padding:6px 12px;width:auto;">Enable Location</button>
          </div>
        </div>
      </div>

      <label>Name</label>
      <input id="name" placeholder="Your name" />

      <label>𝕏 handle</label>
      <input id="handle" placeholder="@heshiebee" value="@"/>

      

      <label>What are you working on?</label>
      <input id="what" type="text" placeholder="Shipping v0 of my budget app..." />

      <button id="toggle" class="btn btn-primary">Lock In</button>
      <button id="shareX" class="btn btn-share">Share to 𝕏</button>

      <div id="nearby" class="row"></div>
      <div id="askCafe" class="ask" style="display:none;"></div>

      <div class="list" id="list"></div>

      <div class="bottom">
        <div class="note">
          Shares your live coordinates while locked in. Auto-removes after 1 hour of inactivity. Made by <a href="https://x.com/heshiebee" target="_blank">@heshiebee</a>
        </div>

        <div style="margin-top:12px; margin-bottom:4px; padding-bottom:16px; display:flex; gap:8px; align-items:center;">
          <button id="showAll" class="btn btn-secondary" style="margin:0;">Show 5 Miles</button>
          <span id="total" class="badge" style="margin-left:auto;">0 total</span>
        </div>
        <div id="viewingMode" class="row" style="display:none; font-size:11px; color:var(--text-muted); margin-top:8px;">
          👁️ Viewing mode - You can see others but aren't sharing your location
        </div>
      </div>
    </div>
    <div id="map" class="map"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    const ft100 = 30.48; // meters
    let map, meMarker, circle;
    const markers = new Map(); // id -> marker
    let me = null; // { id, ... }
    let currentLocation = null; // { lat, lon } - for viewing others without being locked in
    
    // Haversine distance calculation (meters)
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Earth's radius in meters
      const toRad = deg => (deg * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }
    
    // User persistence
    const USER_STORAGE_KEY = 'hustlemaps_user';
    const THEME_STORAGE_KEY = 'hustlemaps_theme';
    let storedUser = null;
    
    // Random emoji assignment
    const EMOJIS = ['🚀', '💻', '⚡', '🔥', '💡', '🎯', '🚀', '⭐', '🌟', '💎', '🎨', '🎵', '🎮', '📱', '💻', '⌨️', '🖥️', '📊', '📈', '🎪', '🎭', '🎨', '🖌️', '✏️', '📝', '📚', '🔬', '🧪', '⚗️', '🔭', '🌌', '🛸', '👨‍💻', '👩‍💻', '🧑‍💻', '👨‍🚀', '👩‍🚀', '🧑‍🚀'];
    const userEmojis = new Map(); // user id -> emoji
    
    function getEmojiForUser(userId) {
      if (!userEmojis.has(userId)) {
        const randomEmoji = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
        userEmojis.set(userId, randomEmoji);
      }
      return userEmojis.get(userId);
    }
    
    function loadStoredUser() {
      try {
        const stored = localStorage.getItem(USER_STORAGE_KEY);
        if (stored) {
          storedUser = JSON.parse(stored);
          // Pre-fill form with stored data
          const nameInput = document.getElementById('name');
          const handleInput = document.getElementById('handle');
          const whatInput = document.getElementById('what');
          if (nameInput && storedUser.name) nameInput.value = storedUser.name;
          if (handleInput && storedUser.x_handle) handleInput.value = storedUser.x_handle;
          if (whatInput && storedUser.what_working_on) whatInput.value = storedUser.what_working_on;
          
          // Restore button state if user was locked in
          if (storedUser.id) {
            me = storedUser;
            const toggleBtn = document.getElementById('toggle');
            if (toggleBtn) {
              toggleBtn.textContent = "I'm done";
              toggleBtn.className = "btn btn-danger";
            }
          }
        }
      } catch (e) {
        console.warn('Failed to load stored user:', e);
      }
    }
    
    function saveUser(user) {
      try {
        localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(user));
        storedUser = user;
      } catch (e) {
        console.warn('Failed to save user:', e);
      }
    }
    
    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
      setTheme(savedTheme);
    }
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const toggle = document.getElementById('themeToggle');
      if (toggle) {
        toggle.textContent = theme === 'dark' ? '☀️' : '🌙';
      }
      localStorage.setItem(THEME_STORAGE_KEY, theme);
    }
    
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    function initMap() {
      map = L.map('map', {
        touchZoom: true,
        doubleClickZoom: true,
        scrollWheelZoom: true,
        dragging: true,
        tap: true,
        tapTolerance: 15
      });
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors',
        subdomains: ['a','b','c']
      });
      osm.addTo(map);

      // Try locate; fallback to NYC
      map.setView([40.73061, -73.935242], 19);
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          currentLocation = { lat, lon };
          map.setView([lat, lon], 19);
          // Load users immediately when we get location
          loadUsers();
        }, (err) => {
          console.warn('Geolocation failed:', err);
          // Still try to load users in case we have stored location
          loadUsers();
        }, {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000
        });
      } else {
        // No geolocation support, still try to load users
        loadUsers();
      }
    }
    
    async function loadUsers() {
      try {
        const users = await fetchActive(!showingAll);
        renderList(users);
        syncMarkers(users);
        
        // Check if stored user is still active
        if (storedUser && storedUser.id) {
          const activeUser = users.find(u => u.id === storedUser.id);
          if (activeUser) {
            me = activeUser;
            // Update stored user with latest data
            saveUser(activeUser);
          } else {
            // User is no longer active, clear stored data and reset UI
            localStorage.removeItem(USER_STORAGE_KEY);
            storedUser = null;
            me = null;
            const toggleBtn = document.getElementById('toggle');
            if (toggleBtn) {
              toggleBtn.textContent = "Lock In";
              toggleBtn.className = "btn btn-primary";
            }
            // Show the form again
            const formEls = ['name','handle','what'].map(id => document.getElementById(id));
            formEls.forEach(el => el && el.classList.remove('hidden'));
            document.querySelectorAll('.panel label').forEach(el => el.classList.remove('hidden'));
            const headerNote = document.getElementById('headerNote');
            if (headerNote) headerNote.innerHTML = `See nearby hustlers or tap <span class=\"badge\">Lock In</span> to share your live pin.`;
          }
        }
        
        // Show/hide location prompt based on whether we have location
        updateLocationPrompt();
      } catch (e) {
        console.warn('Failed to load users:', e);
        updateLocationPrompt();
      }
    }
    
    function updateLocationPrompt() {
      const locationPrompt = document.getElementById('locationPrompt');
      const viewingMode = document.getElementById('viewingMode');
      
      if (locationPrompt) {
        // Show prompt if we don't have location and user is not locked in
        if (!currentLocation && !me) {
          locationPrompt.style.display = 'block';
        } else {
          locationPrompt.style.display = 'none';
        }
      }
      
      if (viewingMode) {
        // Show viewing mode indicator if we have location but user is not locked in
        if (currentLocation && !me) {
          viewingMode.style.display = 'block';
        } else {
          viewingMode.style.display = 'none';
        }
      }
    }
    
    function requestLocationPermission() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
      }
      
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        currentLocation = { lat, lon };
        map.setView([lat, lon], 19);
        updateLocationPrompt();
        loadUsers();
      }, (err) => {
        console.warn('Geolocation failed:', err);
        alert('Unable to get your location. Please check your browser settings and try again.');
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000
      });
    }

    function avatarHtml(u) {
      const hRaw = u.x_handle ? (u.x_handle.startsWith('@') ? u.x_handle : '@' + u.x_handle) : '';
      const handle = hRaw ? ` (<span class=\"handle\">${hRaw}</span>)` : '';
      const venue = (u.is_venue && u.venue_name) ? ` <span class=\"venue\">now at ${u.venue_name}</span>` : '';
      return `<div class=\"person\" data-user-id=\"${u.id}\">\n        <div class=\"one-line\"><strong>${u.name}</strong>${handle}${venue}</div>\n      </div>`;
    }

    function renderList(users) {
      const el = document.getElementById('list');
      
      // Check if current user is in the list (even if me variable isn't set yet)
      const currentUserId = me?.id || storedUser?.id;
      const meUser = currentUserId ? users.find(u => u.id === currentUserId) : null;
      const otherUsers = users.filter(u => !currentUserId || u.id !== currentUserId);
      
      let html = '';
      
      // Show current user at top if found
      if (meUser) {
        html += `<div class="user-me">${avatarHtml(meUser)}</div>`;
      }
      
      // Show other users in scrollable list
      if (otherUsers.length > 0) {
        html += `<div class="user-list">${otherUsers.map(avatarHtml).join('')}</div>`;
      }
      
      el.innerHTML = html;
      
      // Add hover events to show/hide names on map
      el.querySelectorAll('.person').forEach(personEl => {
        const userId = personEl.getAttribute('data-user-id');
        const marker = markers.get(userId);
        
        if (marker) {
          personEl.addEventListener('mouseenter', () => {
            marker.openPopup();
          });
          personEl.addEventListener('mouseleave', () => {
            marker.closePopup();
          });
        }
      });
      
      const total = document.getElementById('total');
      if (total) total.textContent = `${users.length} total`;
    }

    function upsertMarker(u) {
      const emoji = getEmojiForUser(u.id);
      const currentUserId = me?.id || storedUser?.id;
      
      const icon = L.divIcon({
        className: u.id === currentUserId ? "leaflet-div-icon me" : "leaflet-div-icon",
        html: `<div class="pin">
                 <div class="pin-badge">
                   <span class="pin-emoji">${emoji}</span>
                 </div>
                 <div class="pin-pulse"></div>
               </div>`
      });

      let m = markers.get(u.id);
      if (!m) {
        m = L.marker([u.lat, u.lon], { icon }).addTo(map).bindPopup(avatarHtml(u));
        markers.set(u.id, m);
      } else {
        m.setLatLng([u.lat, u.lon]);
        m.setIcon(icon);
        m.setPopupContent(avatarHtml(u));
      }
      
      if (u.id === currentUserId) {
        if (!meMarker) meMarker = m;
        if (circle) circle.setLatLng([u.lat, u.lon]); else circle = L.circle([u.lat, u.lon], {radius: ft100, weight:1}).addTo(map);
      }
    }

    function removeMarker(id) {
      const m = markers.get(id);
      if (m) {
        map.removeLayer(m);
        markers.delete(id);
      }
    }

    // Keep map markers exactly in sync with a given user list
    function syncMarkers(users) {
      try {
        const idsToKeep = new Set(users.map(u => u.id));
        // Remove markers not in the filtered set
        for (const [id, marker] of markers.entries()) {
          if (!idsToKeep.has(id)) {
            map.removeLayer(marker);
            markers.delete(id);
          }
        }
        // Upsert markers for the filtered set
        users.forEach(upsertMarker);
      } catch (_e) {}
    }

    let showingAll = false; // false = nearby (100ft), true = 5 miles
    let lastCenter = null;
    let lastZoom = null;
    
    // Mobile drawer state
    let drawerState = 'closed'; // 'closed', 'partial', 'open'
    
    function toggleDrawer() {
      const panel = document.getElementById('panel');
      const tab = document.getElementById('drawerTab');
      
      if (drawerState === 'closed') {
        drawerState = 'partial';
        panel.classList.add('partial');
        tab.textContent = '↑ More';
      } else if (drawerState === 'partial') {
        drawerState = 'open';
        panel.classList.remove('partial');
        panel.classList.add('open');
        tab.textContent = '↓ Less';
      } else {
        drawerState = 'closed';
        panel.classList.remove('partial', 'open');
        tab.textContent = 'Controls';
      }
    }
    
    function closeDrawer() {
      const panel = document.getElementById('panel');
      const tab = document.getElementById('drawerTab');
      drawerState = 'closed';
      panel.classList.remove('partial', 'open');
      tab.textContent = 'Controls';
    }
    
    function fitMapToAll() {
      const latlngs = Array.from(markers.values()).map(m => m.getLatLng());
      if (!showingAll) {
        lastCenter = map.getCenter();
        lastZoom = map.getZoom();
      }
      if (latlngs.length) {
        const bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds, { padding: [40, 40], maxZoom: 19 });
      }
    }

    // Fit map to a radius (in meters) around a center point
    function fitMapToRadius(lat, lon, radiusMeters) {
      try {
        const bounds = L.circle([lat, lon], { radius: radiusMeters }).getBounds();
        map.fitBounds(bounds, { padding: [40, 40] });
      } catch (_e) {
        // Fallback to setting a reasonable zoom if bounds calc fails
        map.setView([lat, lon], 12);
      }
    }

    async function fetchActive(useNearbyFilter = false) {
      let url = "/api/active";
      let lat, lon;
      
      // Use locked-in user location if available, otherwise use current location
      if (me) {
        lat = me.lat;
        lon = me.lon;
      } else if (currentLocation) {
        lat = currentLocation.lat;
        lon = currentLocation.lon;
      } else {
        // If no location available, return empty array
        return [];
      }
      
      const nearbyParam = useNearbyFilter ? 'true' : 'false';
      url += `?nearby=${nearbyParam}&lat=${lat}&lon=${lon}`;
      
      const r = await fetch(url);
      return await r.json();
    }

    async function checkNearby(lat, lon) {
      const r = await fetch(`/api/nearby?lat=${lat}&lon=${lon}`);
      return await r.json();
    }

    async function checkCafes(lat, lon) {
      const r = await fetch(`/api/cafes?lat=${lat}&lon=${lon}`);
      return await r.json();
    }

    async function lockIn() {
      // get location
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }
      const nameInput = document.getElementById('name');
      const handleInput = document.getElementById('handle');
      const whatInput = document.getElementById('what');
      const name = nameInput ? nameInput.value.trim() : '';
      if (!name) { 
        alert("Name required."); 
        return; 
      }

      const x_handle_raw = handleInput ? handleInput.value.trim() : '';
      const x_handle = x_handle_raw && x_handle_raw !== '@' ? x_handle_raw : '';
      const photo_url = "";
      const what = whatInput ? whatInput.value.trim() : '';

      // Show loading state
      const toggleBtn = document.getElementById('toggle');
      const originalText = toggleBtn.textContent;
      toggleBtn.textContent = "Getting location...";
      toggleBtn.disabled = true;
      toggleBtn.style.opacity = '0.7';

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        // Ask if this is a cafe at your location
        const cafes = await checkCafes(lat, lon);
        let is_venue = false, venue_name = null;
        const ask = document.getElementById('askCafe');
        if (cafes.length) {
          const c = cafes[0]; // nearest
          ask.style.display = 'block';
          ask.innerHTML = `Are you at <strong>${c.name}</strong>? 
            <div style="margin-top:6px;">
              <button id="yesCafe" class="btn btn-primary" style="padding:6px 10px;width:auto;">Yes</button>
              <button id="noCafe" class="btn btn-danger" style="padding:6px 10px;width:auto;">No</button>
            </div>`;
          await new Promise(resolve => {
            document.getElementById('yesCafe').onclick = () => { is_venue = true; venue_name = c.name; ask.style.display='none'; resolve(); };
            document.getElementById('noCafe').onclick  = () => { is_venue = false; venue_name = null; ask.style.display='none'; resolve(); };
          });
        } else {
          ask.style.display = 'none';
        }

        const payload = {
          id: me?.id, name, x_handle, photo_url, what_working_on: what,
          lat, lon, is_venue, venue_name
        };
        const r = await fetch("/api/lockin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const user = await r.json();
        me = user;
        saveUser(user); // Save to localStorage
        upsertMarker(me);
        map.setView([me.lat, me.lon], 19);
        
        // Restore button state
        toggleBtn.textContent = "I'm done";
        toggleBtn.className = "btn btn-danger";
        toggleBtn.disabled = false;
        toggleBtn.style.opacity = '1';
        
        // Hide input fields while locked in and update header note
        const formEls = ['name','handle','what'].map(id => document.getElementById(id));
        formEls.forEach(el => el && el.classList.add('hidden'));
        document.querySelectorAll('.panel label').forEach(el => el.classList.add('hidden'));
        const headerNote = document.getElementById('headerNote');
        if (headerNote) headerNote.innerHTML = `Tap <span class=\"badge\">I'm done</span> when you want to stop sharing.`;

        // Close drawer on mobile after successful lock-in
        if (window.innerWidth <= 768) {
          closeDrawer();
        }

        // show nearby
        const near = await checkNearby(lat, lon);
        const others = near.filter(u => u.id !== me.id);
        document.getElementById('nearby').textContent =
          others.length ? `${others.length} locked-in hustlers within 100 ft.` : "No one within 100 ft (yet). Be the beacon.";

        // Refresh list now that we're locked in so "You" appears immediately
        try {
          const usersNow = await fetchActive(!showingAll);
          renderList(usersNow);
        } catch (_e) {}
      }, err => {
        alert("Location failed: " + err.message);
        // Restore button state on error
        toggleBtn.textContent = originalText;
        toggleBtn.disabled = false;
        toggleBtn.style.opacity = '1';
      }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
    }

    async function done() {
      if (!me?.id) return;
      await fetch("/api/done", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: me.id })
      });
      removeMarker(me.id);
      me = null;
      if (circle) { map.removeLayer(circle); circle = null; }
      document.getElementById('toggle').textContent = "Lock In";
      document.getElementById('toggle').className = "btn btn-primary";
      document.getElementById('nearby').textContent = "";

      // Show input fields again and restore header note
      const formEls = ['name','handle','what'].map(id => document.getElementById(id));
      formEls.forEach(el => el && el.classList.remove('hidden'));
      document.querySelectorAll('.panel label').forEach(el => el.classList.remove('hidden'));
      const headerNote = document.getElementById('headerNote');
      if (headerNote) headerNote.innerHTML = `See nearby hustlers or tap <span class=\"badge\">Lock In</span> to share your live pin.`;
    }

    function setupSocket() {
      const socket = io();
      socket.on("presence:full", () => {
        loadUsers();
      });
      socket.on("presence:update", () => {
        loadUsers();
      });
      socket.on("presence:remove", () => {
        loadUsers();
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      initTheme(); // Initialize theme
      loadStoredUser(); // Load stored user data
      initMap();
      setTimeout(() => map.invalidateSize(), 100);
      
      // Handle window resize for mobile layout changes
      window.addEventListener('resize', () => {
        setTimeout(() => map.invalidateSize(), 100);
      });
      
      // Handle orientation change on mobile
      window.addEventListener('orientationchange', () => {
        setTimeout(() => map.invalidateSize(), 500);
      });
      
      setupSocket();

      // initial load will happen in initMap when location is available
      
      // Check if stored user is still active and restore state
      if (storedUser && storedUser.id) {
        // We'll check this after we load users in loadUsers function
        // For now, just set up the UI state
        me = storedUser;
        const toggleBtn = document.getElementById('toggle');
        if (toggleBtn) {
          toggleBtn.textContent = "I'm done";
          toggleBtn.className = "btn btn-danger";
        }
        // Hide the form and update header since user was locked in
        const formEls = ['name','handle','what'].map(id => document.getElementById(id));
        formEls.forEach(el => el && el.classList.add('hidden'));
        document.querySelectorAll('.panel label').forEach(el => el.classList.add('hidden'));
        const headerNote = document.getElementById('headerNote');
        if (headerNote) headerNote.innerHTML = `Tap <span class=\"badge\">I'm done</span> when you want to stop sharing.`;
      }

      // button
      document.getElementById('toggle').addEventListener('click', async () => {
        if (me?.id) await done(); else await lockIn();
      });

      // show all (5 miles) / nearby (100 ft)
      document.getElementById('showAll').addEventListener('click', async (e) => {
        showingAll = !showingAll;
        if (showingAll) {
          e.currentTarget.textContent = 'Show Nearby';
          // Save current view to restore later
          lastCenter = map.getCenter();
          lastZoom = map.getZoom();
          if (me?.id) {
            // 5 miles in meters
            fitMapToRadius(me.lat, me.lon, 8046.72);
          } else if (currentLocation) {
            fitMapToRadius(currentLocation.lat, currentLocation.lon, 8046.72);
          } else {
          fitMapToAll();
          }
          setTimeout(() => map.invalidateSize(), 150);
        } else {
          e.currentTarget.textContent = 'Show 5 Miles';
          if (lastCenter && lastZoom) {
            map.setView(lastCenter, lastZoom);
          } else if (me?.id) {
            map.setView([me.lat, me.lon], 17);
          } else if (currentLocation) {
            map.setView([currentLocation.lat, currentLocation.lon], 17);
          } else {
            fitMapToAll();
          }
          setTimeout(() => map.invalidateSize(), 150);
        }
        
        // Refresh the user list and markers with new filter
        const users = await fetchActive(!showingAll);
        renderList(users);
        syncMarkers(users);
      });

      // theme toggle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // location permission
      document.getElementById('enableLocation').addEventListener('click', requestLocationPermission);
      
      // mobile drawer controls
      document.getElementById('drawerTab').addEventListener('click', toggleDrawer);
      document.getElementById('drawerHandle').addEventListener('click', toggleDrawer);
      
      // Add touch gesture support for drawer
      let startY = 0;
      let currentY = 0;
      let isDragging = false;
      
      const panel = document.getElementById('panel');
      
      panel.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
        isDragging = true;
      });
      
      panel.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentY = e.touches[0].clientY;
        const deltaY = currentY - startY;
        
        // If swiping down and drawer is open, close it
        if (deltaY > 50 && (drawerState === 'open' || drawerState === 'partial')) {
          closeDrawer();
          isDragging = false;
        }
      });
      
      panel.addEventListener('touchend', () => {
        isDragging = false;
      });

      // share to X with static map
      document.getElementById('shareX').addEventListener('click', () => {
        if (!me?.id) {
          alert('Please lock in first to share your location!');
          return;
        }
        
        const center = [me.lat, me.lon];
        const zoom = Math.min(map.getZoom(), 16); // Cap zoom for better overview
        
        // Create markers string for all visible users
        const visibleMarkers = Array.from(markers.values())
          .filter(marker => map.hasLayer(marker))
          .map(marker => {
            const latLng = marker.getLatLng();
            return `${latLng.lat},${latLng.lng},lightblue1`;
          });
        
        // Add current user marker in different color
        const userMarker = `${me.lat},${me.lon},red1`;
        const allMarkers = [userMarker, ...visibleMarkers.filter(m => m !== userMarker)].join('|');
        
        const text = encodeURIComponent(`I'm locked in on HustleMaps dot com`);
        const imgUrl = `https://staticmap.openstreetmap.de/staticmap.php?center=${center[0]},${center[1]}&zoom=${zoom}&size=800x400&maptype=mapnik&markers=${allMarkers}`;
        const url = `${location.origin}/share/${encodeURIComponent(me.id)}`;
        
        // Add comprehensive meta tags for image previews across all platforms
        const metaTags = [
          // Open Graph (Facebook, LinkedIn, etc.)
          { property: 'og:image', content: imgUrl },
          { property: 'og:image:width', content: '800' },
          { property: 'og:image:height', content: '400' },
          { property: 'og:image:type', content: 'image/png' },
          { property: 'og:title', content: "I'm locked in on HustleMaps" },
          { property: 'og:description', content: 'Join me and other hustlers working nearby!' },
          { property: 'og:url', content: url },
          
          // Twitter Card
          { name: 'twitter:card', content: 'summary_large_image' },
          { name: 'twitter:image', content: imgUrl },
          { name: 'twitter:title', content: "I'm locked in on HustleMaps" },
          { name: 'twitter:description', content: 'Join me and other hustlers working nearby!' },
          
          // Additional platforms
          { name: 'image', content: imgUrl },
          { itemprop: 'image', content: imgUrl }
        ];
        
        metaTags.forEach(tag => {
          const meta = document.createElement('meta');
          if (tag.property) {
            meta.setAttribute('property', tag.property);
          } else if (tag.name) {
            meta.setAttribute('name', tag.name);
          } else if (tag.itemprop) {
            meta.setAttribute('itemprop', tag.itemprop);
          }
          meta.setAttribute('content', tag.content);
          document.head.appendChild(meta);
        });

        const intent = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
        window.open(intent, '_blank');
      });

      // Auto-refresh user list every 30 seconds
      setInterval(async () => {
        await loadUsers();
      }, 30000);

      // while locked in, refresh location every ~60s to keep alive
      setInterval(async () => {
        if (!me?.id || !navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const payload = {
            ...me,
            lat: pos.coords.latitude,
            lon: pos.coords.longitude
          };
          const r = await fetch("/api/lockin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const updated = await r.json();
          me = updated;
        });
      }, 60000);
    });
  </script>
</body>
</html>
